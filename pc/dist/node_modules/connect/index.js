/*!
 * connect
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */

function createServer(){function e(r,t,n){e.handle(r,t,n)}return merge(e,proto),merge(e,EventEmitter.prototype),e.route="/",e.stack=[],e}function call(e,r,t,n,o,i){var u=e.length,l=t,s=Boolean(t);debug("%s %s : %s",e.name||"<anonymous>",r,n.originalUrl);try{if(s&&4===u)return void e(t,n,o,i);if(!s&&u<4)return void e(n,o,i)}catch(e){l=e}i(l)}function logerror(e){"test"!==env&&console.error(e.stack||e.toString())}function getProtohost(e){if(0!==e.length&&"/"!==e[0]){var r=e.indexOf("?"),t=r!==-1?r:e.length,n=e.substr(0,t).indexOf("://");return n!==-1?e.substr(0,e.indexOf("/",3+n)):void 0}}var debug=require("debug")("connect:dispatcher"),EventEmitter=require("events").EventEmitter,finalhandler=require("finalhandler"),http=require("http"),merge=require("utils-merge"),parseUrl=require("parseurl");module.exports=createServer;var env=process.env.NODE_ENV||"development",proto={},defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};proto.use=function(e,r){var t=r,n=e;if("string"!=typeof e&&(t=e,n="/"),"function"==typeof t.handle){var o=t;o.route=n,t=function(e,r,t){o.handle(e,r,t)}}return t instanceof http.Server&&(t=t.listeners("request")[0]),"/"===n[n.length-1]&&(n=n.slice(0,-1)),debug("use %s %s",n||"/",t.name||"anonymous"),this.stack.push({route:n,handle:t}),this},proto.handle=function(e,r,t){function n(t){l&&(e.url=e.url.substr(1),l=!1),0!==u.length&&(e.url=i+u+e.url.substr(i.length),u="");var h=s[o++];if(!h)return void defer(a,t);var c=parseUrl(e).pathname||"/",f=h.route;if(c.toLowerCase().substr(0,f.length)!==f.toLowerCase())return n(t);var v=c[f.length];return void 0!==v&&"/"!==v&&"."!==v?n(t):(0!==f.length&&"/"!==f&&(u=f,e.url=i+e.url.substr(i.length+u.length),i||"/"===e.url[0]||(e.url="/"+e.url,l=!0)),void call(h.handle,f,t,e,r,n))}var o=0,i=getProtohost(e.url)||"",u="",l=!1,s=this.stack,a=t||finalhandler(e,r,{env:env,onerror:logerror});e.originalUrl=e.originalUrl||e.url,n()},proto.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};