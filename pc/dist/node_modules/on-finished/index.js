/*!
 * on-finished
 * Copyright(c) 2013 Jonathan Ong
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */

"use strict";function onFinished(e,n){return isFinished(e)!==!1?(defer(n,null,e),e):(attachListener(e,n),e)}function isFinished(e){var n=e.socket;return"boolean"==typeof e.finished?Boolean(e.finished||n&&!n.writable):"boolean"==typeof e.complete?Boolean(e.upgrade||!n||!n.readable||e.complete&&!e.readable):void 0}function attachFinishedListener(e,n){function i(e){o.cancel(),s.cancel(),r=!0,n(e)}function t(n){e.removeListener("socket",t),r||o===s&&(s=first([[n,"error","close"]],i))}var o,s,r=!1;return o=s=first([[e,"end","finish"]],i),e.socket?void t(e.socket):(e.on("socket",t),void(void 0===e.socket&&patchAssignSocket(e,t)))}function attachListener(e,n){var i=e.__onFinished;i&&i.queue||(i=e.__onFinished=createListener(e),attachFinishedListener(e,i)),i.queue.push(n)}function createListener(e){function n(i){if(e.__onFinished===n&&(e.__onFinished=null),n.queue){var t=n.queue;n.queue=null;for(var o=0;o<t.length;o++)t[o](i,e)}}return n.queue=[],n}function patchAssignSocket(e,n){var i=e.assignSocket;"function"==typeof i&&(e.assignSocket=function(e){i.call(this,e),n(e)})}module.exports=onFinished,module.exports.isFinished=isFinished;var first=require("ee-first"),defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};