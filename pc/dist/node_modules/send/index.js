/*!
 * send
 * Copyright(c) 2012 TJ Holowaychuk
 * Copyright(c) 2014-2016 Douglas Christopher Wilson
 * MIT Licensed
 */

"use strict";function send(e,t,r){return new SendStream(e,t,r)}function SendStream(e,t,r){Stream.call(this);var n=r||{};if(this.options=n,this.path=t,this.req=e,this._acceptRanges=void 0===n.acceptRanges||Boolean(n.acceptRanges),this._cacheControl=void 0===n.cacheControl||Boolean(n.cacheControl),this._etag=void 0===n.etag||Boolean(n.etag),this._dotfiles=void 0!==n.dotfiles?n.dotfiles:"ignore","ignore"!==this._dotfiles&&"allow"!==this._dotfiles&&"deny"!==this._dotfiles)throw new TypeError('dotfiles option must be "allow", "deny", or "ignore"');this._hidden=Boolean(n.hidden),void 0!==n.hidden&&deprecate("hidden: use dotfiles: '"+(this._hidden?"allow":"ignore")+"' instead"),void 0===n.dotfiles&&(this._dotfiles=void 0),this._extensions=void 0!==n.extensions?normalizeList(n.extensions,"extensions option"):[],this._index=void 0!==n.index?normalizeList(n.index,"index option"):["index.html"],this._lastModified=void 0===n.lastModified||Boolean(n.lastModified),this._maxage=n.maxAge||n.maxage,this._maxage="string"==typeof this._maxage?ms(this._maxage):Number(this._maxage),this._maxage=isNaN(this._maxage)?0:Math.min(Math.max(0,this._maxage),MAX_MAXAGE),this._root=n.root?resolve(n.root):null,!this._root&&n.from&&this.from(n.from)}function clearHeaders(e){e._headers={},e._headerNames={}}function collapseLeadingSlashes(e){for(var t=0;t<e.length&&"/"===e[t];t++);return t>1?"/"+e.substr(t):e}function containsDotFile(e){for(var t=0;t<e.length;t++)if("."===e[t][0])return!0;return!1}function contentRange(e,t,r){return e+" "+(r?r.start+"-"+r.end:"*")+"/"+t}function decode(e){try{return decodeURIComponent(e)}catch(e){return-1}}function normalizeList(e,t){for(var r=[].concat(e||[]),n=0;n<r.length;n++)if("string"!=typeof r[n])throw new TypeError(t+" must be array of strings or false");return r}function setHeaders(e,t){for(var r=Object.keys(t),n=0;n<r.length;n++){var i=r[n];e.setHeader(i,t[i])}}var createError=require("http-errors"),debug=require("debug")("send"),deprecate=require("depd")("send"),destroy=require("destroy"),encodeUrl=require("encodeurl"),escapeHtml=require("escape-html"),etag=require("etag"),EventEmitter=require("events").EventEmitter,fresh=require("fresh"),fs=require("fs"),mime=require("mime"),ms=require("ms"),onFinished=require("on-finished"),parseRange=require("range-parser"),path=require("path"),statuses=require("statuses"),Stream=require("stream"),util=require("util"),extname=path.extname,join=path.join,normalize=path.normalize,resolve=path.resolve,sep=path.sep,BYTES_RANGE_REGEXP=/^ *bytes=/,MAX_MAXAGE=31536e6,UP_PATH_REGEXP=/(?:^|[\\\/])\.\.(?:[\\\/]|$)/;module.exports=send,module.exports.mime=mime;var listenerCount=EventEmitter.listenerCount||function(e,t){return e.listeners(t).length};util.inherits(SendStream,Stream),SendStream.prototype.etag=deprecate.function(function(e){return this._etag=Boolean(e),debug("etag %s",this._etag),this},"send.etag: pass etag as option"),SendStream.prototype.hidden=deprecate.function(function(e){return this._hidden=Boolean(e),this._dotfiles=void 0,debug("hidden %s",this._hidden),this},"send.hidden: use dotfiles option"),SendStream.prototype.index=deprecate.function(function e(t){var e=t?normalizeList(t,"paths argument"):[];return debug("index %o",t),this._index=e,this},"send.index: pass index as option"),SendStream.prototype.root=function(e){return this._root=resolve(String(e)),debug("root %s",this._root),this},SendStream.prototype.from=deprecate.function(SendStream.prototype.root,"send.from: pass root as option"),SendStream.prototype.root=deprecate.function(SendStream.prototype.root,"send.root: pass root as option"),SendStream.prototype.maxage=deprecate.function(function(e){return this._maxage="string"==typeof e?ms(e):Number(e),this._maxage=isNaN(this._maxage)?0:Math.min(Math.max(0,this._maxage),MAX_MAXAGE),debug("max-age %d",this._maxage),this},"send.maxage: pass maxAge as option"),SendStream.prototype.error=function e(t,e){if(0!==listenerCount(this,"error"))return this.emit("error",createError(e,t,{expose:!1}));var r=this.res,n=statuses[t];clearHeaders(r),e&&e.headers&&setHeaders(r,e.headers),r.statusCode=t,r.setHeader("Content-Type","text/plain; charset=UTF-8"),r.setHeader("Content-Length",Buffer.byteLength(n)),r.setHeader("X-Content-Type-Options","nosniff"),r.end(n)},SendStream.prototype.hasTrailingSlash=function(){return"/"===this.path[this.path.length-1]},SendStream.prototype.isConditionalGET=function(){return this.req.headers["if-none-match"]||this.req.headers["if-modified-since"]},SendStream.prototype.removeContentHeaderFields=function(){for(var e=this.res,t=Object.keys(e._headers||{}),r=0;r<t.length;r++){var n=t[r];"content-"===n.substr(0,8)&&"content-location"!==n&&e.removeHeader(n)}},SendStream.prototype.notModified=function(){var e=this.res;debug("not modified"),this.removeContentHeaderFields(),e.statusCode=304,e.end()},SendStream.prototype.headersAlreadySent=function(){var e=new Error("Can't set headers after they are sent.");debug("headers already sent"),this.error(500,e)},SendStream.prototype.isCachable=function(){var e=this.res.statusCode;return e>=200&&e<300||304===e},SendStream.prototype.onStatError=function(e){switch(e.code){case"ENAMETOOLONG":case"ENOENT":case"ENOTDIR":this.error(404,e);break;default:this.error(500,e)}},SendStream.prototype.isFresh=function(){return fresh(this.req.headers,this.res._headers)},SendStream.prototype.isRangeFresh=function(){var e=this.req.headers["if-range"];return!e||(~e.indexOf('"')?~e.indexOf(this.res._headers.etag):Date.parse(this.res._headers["last-modified"])<=Date.parse(e))},SendStream.prototype.redirect=function(e){if(0!==listenerCount(this,"directory"))return void this.emit("directory");if(this.hasTrailingSlash())return void this.error(403);var t=encodeUrl(collapseLeadingSlashes(e+"/")),r='Redirecting to <a href="'+escapeHtml(t)+'">'+escapeHtml(t)+"</a>\n",n=this.res;n.statusCode=301,n.setHeader("Content-Type","text/html; charset=UTF-8"),n.setHeader("Content-Length",Buffer.byteLength(r)),n.setHeader("X-Content-Type-Options","nosniff"),n.setHeader("Location",t),n.end(r)},SendStream.prototype.pipe=function(e){var t=this._root;this.res=e;var r=decode(this.path);if(r===-1)return this.error(400),e;if(~r.indexOf("\0"))return this.error(400),e;var n;if(null!==t){if(UP_PATH_REGEXP.test(normalize("."+sep+r)))return debug('malicious path "%s"',r),this.error(403),e;r=normalize(join(t,r)),t=normalize(t+sep),n=r.substr(t.length).split(sep)}else{if(UP_PATH_REGEXP.test(r))return debug('malicious path "%s"',r),this.error(403),e;n=normalize(r).split(sep),r=resolve(r)}if(containsDotFile(n)){var i=this._dotfiles;switch(void 0===i&&(i="."===n[n.length-1][0]?this._hidden?"allow":"ignore":"allow"),debug('%s dotfile "%s"',i,r),i){case"allow":break;case"deny":return this.error(403),e;case"ignore":default:return this.error(404),e}}return this._index.length&&"/"===this.path[this.path.length-1]?(this.sendIndex(r),e):(this.sendFile(r),e)},SendStream.prototype.send=function(e,t){var r=t.size,n=this.options,i={},s=this.res,o=this.req,a=o.headers.range,d=n.start||0;if(s._header)return void this.headersAlreadySent();if(debug('pipe "%s"',e),this.setHeader(e,t),this.type(e),this.isConditionalGET()&&this.isCachable()&&this.isFresh())return void this.notModified();if(r=Math.max(0,r-d),void 0!==n.end){var h=n.end-d+1;r>h&&(r=h)}if(this._acceptRanges&&BYTES_RANGE_REGEXP.test(a)){if(a=parseRange(r,a,{combine:!0}),this.isRangeFresh()||(debug("range stale"),a=-2),a===-1)return debug("range unsatisfiable"),s.setHeader("Content-Range",contentRange("bytes",r)),this.error(416,{headers:{"Content-Range":s.getHeader("Content-Range")}});a!==-2&&1===a.length&&(debug("range %j",a),s.statusCode=206,s.setHeader("Content-Range",contentRange("bytes",r,a[0])),d+=a[0].start,r=a[0].end-a[0].start+1)}for(var u in n)i[u]=n[u];return i.start=d,i.end=Math.max(d,d+r-1),s.setHeader("Content-Length",r),"HEAD"===o.method?void s.end():void this.stream(e,i)},SendStream.prototype.sendFile=function(e){function t(i){if(n._extensions.length<=r)return i?n.onStatError(i):n.error(404);var s=e+"."+n._extensions[r++];debug('stat "%s"',s),fs.stat(s,function(e,r){return e?t(e):r.isDirectory()?t():(n.emit("file",s,r),void n.send(s,r))})}var r=0,n=this;debug('stat "%s"',e),fs.stat(e,function(r,i){return r&&"ENOENT"===r.code&&!extname(e)&&e[e.length-1]!==sep?t(r):r?n.onStatError(r):i.isDirectory()?n.redirect(n.path):(n.emit("file",e,i),void n.send(e,i))})},SendStream.prototype.sendIndex=function(e){function t(i){if(++r>=n._index.length)return i?n.onStatError(i):n.error(404);var s=join(e,n._index[r]);debug('stat "%s"',s),fs.stat(s,function(e,r){return e?t(e):r.isDirectory()?t():(n.emit("file",s,r),void n.send(s,r))})}var r=-1,n=this;t()},SendStream.prototype.stream=function e(t,r){var n=!1,i=this,s=this.res,e=fs.createReadStream(t,r);this.emit("stream",e),e.pipe(s),onFinished(s,function(){n=!0,destroy(e)}),e.on("error",function(t){n||(n=!0,destroy(e),i.onStatError(t))}),e.on("end",function(){i.emit("end")})},SendStream.prototype.type=function e(t){var r=this.res;if(!r.getHeader("Content-Type")){var e=mime.lookup(t);if(!e)return void debug("no content-type");var n=mime.charsets.lookup(e);debug("content-type %s",e),r.setHeader("Content-Type",e+(n?"; charset="+n:""))}},SendStream.prototype.setHeader=function(e,t){var r=this.res;if(this.emit("headers",r,e,t),this._acceptRanges&&!r.getHeader("Accept-Ranges")&&(debug("accept ranges"),r.setHeader("Accept-Ranges","bytes")),this._cacheControl&&!r.getHeader("Cache-Control")){var n="public, max-age="+Math.floor(this._maxage/1e3);debug("cache-control %s",n),r.setHeader("Cache-Control",n)}if(this._lastModified&&!r.getHeader("Last-Modified")){var i=t.mtime.toUTCString();debug("modified %s",i),r.setHeader("Last-Modified",i)}if(this._etag&&!r.getHeader("ETag")){var s=etag(t);debug("etag %s",s),r.setHeader("ETag",s)}};