/*!
 * finalhandler
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */

"use strict";function finalhandler(e,t,s){var n=s||{},r=n.env||process.env.NODE_ENV||"development",a=n.onerror;return function(s){var n,d=Object.create(null);if(!s&&t._header)return void debug("cannot 404 after headers sent");if(s){if(n=getErrorStatusCode(s)||t.statusCode,("number"!=typeof n||n<400||n>599)&&(n=500),s.headers&&(s.status===n||s.statusCode===n))for(var o=Object.keys(s.headers),u=0;u<o.length;u++){var i=o[u];d[i]=s.headers[i]}var f="production"===r?statuses[n]:s.stack||s.toString();f=escapeHtml(f).replace(/\n/g,"<br>").replace(/\x20{2}/g," &nbsp;")+"\n"}else n=404,f="Cannot "+escapeHtml(e.method)+" "+escapeHtml(e.originalUrl||e.url)+"\n";return debug("default %s",n),s&&a&&defer(a,s,e,t),t._header?(debug("cannot %d after headers sent",n),void e.socket.destroy()):void send(e,t,n,d,f)}}function getErrorStatusCode(e){return"number"==typeof e.status&&e.status>=400&&e.status<600?e.status:"number"==typeof e.statusCode&&e.statusCode>=400&&e.statusCode<600?e.statusCode:void 0}function send(e,t,s,n,r){function a(){t.statusCode=s,t.statusMessage=statuses[s];for(var a=Object.keys(n),d=0;d<a.length;d++){var o=a[d];t.setHeader(o,n[o])}return t.setHeader("X-Content-Type-Options","nosniff"),t.setHeader("Content-Type","text/html; charset=utf-8"),t.setHeader("Content-Length",Buffer.byteLength(r,"utf8")),"HEAD"===e.method?void t.end():void t.end(r,"utf8")}return isFinished(e)?void a():(unpipe(e),onFinished(e,a),void e.resume())}var debug=require("debug")("finalhandler"),escapeHtml=require("escape-html"),onFinished=require("on-finished"),statuses=require("statuses"),unpipe=require("unpipe"),defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))},isFinished=onFinished.isFinished;module.exports=finalhandler;